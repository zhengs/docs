---
title: Google Maps
layout: tutorials.hbs
columns: two
order: 150
---

# {{title}} Integration

Particle and Google Maps can now be used in tandem to easily find the location of
Particle devices without the need for any additional hardware. The <a href="https://developers.google.com/maps/documentation/geolocation/intro" target="_blank">Geolocation API</a>
from Google Maps returns a location and accuracy radius from visible Wi-Fi access points
or cell towers collected by Particle devices.

<img src="/assets/images/particle+gm.png"
alt="Particle + Azure IoT Hub"/>
<p class="caption">Geolocate Particle devices using the Google Maps
Geolocation API</p>

Geolocating devices has many potential applications in an IoT deployment,
including:

- *Improve operating efficiency* via remote tracking of assets in a
company's supply chain, including improving demand forecasting and
reducing operating expenses. For more details, please check out our <a href="https://www.particle.io/white-papers/iot-revolutionizing-supply-chain-management"
target="_blank">whitepaper on supply chain management</a>
- *Delight customers* via providing visibility into the
location of connected devices to end-users in real-time
- *Discover business insights* via collecting and identifying device location data

This tutorial will explore how to get started with the Particle + Google
Maps integration.

## Geolocation basics

There are four common ways to find a location of a device, described
below. It is important to note that while these methods are distinct
from one another, it is possible (and often preferrable) to use multiple
geolocation methods together to enhance end-user experience and/or
increase the likelihood of successfully locating a device.

### GPS (Global Positioning System)

The Global Positioning System (GPS) is generally the most accurate and
it can provide device location continuously. Under normal conditions,
GPS can locate a device with an accuracy of ~4 meters.

While very accurate, the disadvantage is that GPS requires additional hardware like the Particle [Asset Tracker module](https://www.particle.io/products/hardware/asset-tracker). It may also take some time to establish a satellite fix, and may have trouble establishing a location where the view is obstructed, such as downtown in cities.

The Particle + Google Maps integration does not use GPS, but rather
cell towers or Wi-Fi networks to geolocate a device. Read on for a
description of these two geolocation methods.

### Cellular tower location

Cell tower geolocation is ideal for cellular IoT deployments that require approximate locations
and do not wish to include additional hardware to support GPS.

Every cell tower has an identifier, and this can be looked up using the Google Geolocation API to find its location. This process is fast and provides a general location, usually within 4000 meters or a couple miles.

The Google Maps integration can be used in tandem with a Particle
Electron to geolocate devices using visible cellular networks.

### Wi-Fi location

For the Particle Photon and P1, Wi-Fi geolocation is another option.
Google maintains a database of known Wi-Fi base stations and can use
this to determine a device's  location by what networks it can see.

The database is generated by information from Android smart phones with
location services enabled. They periodically record both the visible
Wi-Fi access points and GPS locations when location services is enabled.
(Apple uses the same technique with iPhones for their Wi-Fi location
database, but it's a different database than Google's database.) Not all
Wi-Fi access points are included in these databases, but if a device is near one,
it can provide accurate location information.

The Google Maps integration also supports this method of geolocation.
Particle Photon and P1 (Wi-Fi) devices can collect visible Wi-Fi access
points, and send these to the geolocation API in exchange for its
location. Often times, Wi-Fi geolocation is more precise than cellular
geolocation, often with an accuracy radius of 50 meters or less.

### IP Address location

The Google Maps Device Locator does not use this technique, but for home
Wi-Fi networks it's often possible to get an approximate location (city
or nearby city), based on the public IP address. Particle Wi-Fi devices
report their last IP address to the cloud, which could be used for this
geolocation method. This is most often the least accurate of the 4
methods described in this section.

## Preconfiguration steps

### Sign up for a Google account

If you do not already have an account, visit the <a href="https://accounts.google.com/signup?hl=en" target="_blank">Google signup page</a>.
Follow the instructions to register for a new account. A Google account
is needed to successfully authenticate with the Google Maps Geolocation
API.

### Get a Google Geolocation API Key

In order to use the Google Geolocation API, you need an API key. In many cases, you'll be able to take advantage of the free usage tier.

- Go to the [Google Geolocation API page](https://developers.google.com/maps/documentation/geolocation/intro).

- If you are not signed into Google already, sign in (1).

- Use the **Get a Key** button (2) to request a new API key.

![Get a key](/assets/images/google-maps-03.png)

- Select or create a project.

![Select or create project](/assets/images/google-maps-04.png)

- In many cases you'll want to **Create a new project**. Every key is associated with one project, though a project can have a number of different keys, and also be enabled for multiple services.

![Create a new project](/assets/images/google-maps-05.png)

- I created a new project **location** and use the **Enable API** button to enable it.

![Enable API](/assets/images/google-maps-06.png)

- And then you'll be presented with your API key.

![API Key](/assets/images/google-maps-07.png)

Copy your key to the clipboard because you'll need it when you enable your integration.

To view, edit or delete your credentials later, you can use the [Google Developer Credentials Console](https://console.developers.google.com/apis/credentials).

### Run the Google Maps firmware library on your devices

The final preconfiguration step is the firmware that you flash to your
Particle device. In order for Google Maps to geolocate a device, the
device must collect a list of currently visible networks (access points
for Wi-Fi, and towers for Cellular) and send information about these
networks to the cloud.

A verified Particle library must be added to a device's firmware to
collect and send network info to successfully fetch its location from
Google Maps.


#### Using Particle Build (Web IDE)

- Select the **Libraries** icon (1)

![Libraries](/assets/images/google-maps-10.png)

- Enter **google-maps** in the search box (1) and select **google-maps-device-locator**.

![Select google-maps-device-locator](/assets/images/google-maps-11.png)

- Select **simple.ino** under examples to try a simple sample application.

![Select example](/assets/images/google-maps-12.png)

- Click the **Use this example** button to create a new project using this example.

![Use this example](/assets/images/google-maps-13.png)

- Now you can view and edit the code.

This example publishes the location every 2 minutes (120 seconds). It works on the Particle Photon, P1, and Core (Wi-Fi) and also the Electron (cellular).

By changing a few options you can have it publish once at boot, which might be appropriate for Wi-Fi devices that are not battery powered. You can also post location on demand, when you make a call from your code.

## Enabling the Integration

### Particle Console

Now that you've done all of the pre-configuration, you are now ready to
enable the Google Maps integration
on the <a href="https://console.particle.io" target="_blank">Particle Console</a>.

Start by going to the integrations hub by clicking on the integrations icon in the sidebar (<i class="im-integrations-icon"></i>), or
by simply <a href="https://console.particle.io/integrations" target="_blank">following this link</a>. If you'd like to enable the integration
for a <a href="/guide/tools-and-features/console/#devices-vs-product-devices" target="_blank">product</a>, you'll need to visit the integrations
hub for the desired product. Do this by clicking the products icon (<i class="im-product-icon"></i>) in the sidebar, finding your product,
then clicking on the integrations icon (<i class="im-integrations-icon"></i>) in the product context.

Once in the integrations hub, click on the "New Integration" button.
From the list of available integrations, click on "Google Maps."

<img src="/assets/images/google-maps-01.png"/>

You'll see a reminder that setup is required before continuing to enable the integration. If you have followed the steps above, you should be good to go. Click the "I have done all these things" button to advance.

The next step is configuring the integration. Fill out the following fields:

- **API Key**: Enter the API key you created above.

- **Device**: Select which of your devices will trigger publishing to Google. If you'd like the publish to trigger from any of the devices you own, select 'Any.'

![Integration Configuraton](/assets/images/google-maps-02.png)

If you expand **Advanced Settings** the following option appears:

- **Override Default Event Name**: The name of the event that will
trigger publishing an event to Google Maps. This is the name of your event set using `locator.withEventName("differentEventName")`.


### Testing it out

Once you have the firmware installed on yourd device and the integration
enabled Electron, you can check the Logs in the [console](https://console.particle.io/logs).

![Event Log](/assets/images/google-maps-16.png)

From the bottom to the top:

- The **deviceLocator** event is what was sent from the Electron
- The **hookSent/deviceLocator** is what the Particle cloud sent to the Google Geolocation service. The data is always undefined; that's the normal behavior.
- The **hook-** is the response data: latitude,longitude,uncertainty. The uncertainty radius is in meters.

If the location is not known by the Google geolocation service, a 404 error appear in the logs instead:

![Event Log 404](/assets/images/google-maps-17.png)

## Firmware examples

The Google Maps device locator firmware library source code is in the Github repository:

[https://github.com/rickkas7/google-maps-device-locator-examples](https://github.com/rickkas7/google-maps-device-locator-examples)

To use these firmware examples, you should downlod the repo, either by clone or download zip.

### Using the Particle CLI

Using the [Particle CLI](https://docs.particle.io/guide/tools-and-features/cli/) is an easy to run run these examples.

For example, if you wanted to flash the oled-locator example to the device you named "test2" then you'd use the commands:

```
cd oled-locator
particle flash test2 .
```

That will automatically include the necessary libraries for you.

For an Electron, you'll probably want to do:

```
cd oled-locator
particle compile electron . --saveTo firmware.bin
particle flash --usb firmware.bin
```

### Using Particle Dev (Atom IDE)

It's also easy to open examples using Particle Dev (Atom IDE).

![Particle DEV](/assets/images/google-maps-18.png)

Makes sure you have a recent version of Particle Dev, as older versions don't know how to automatically load libraries. 

Also, you want to make sure you close all open windows, then open the .cpp file for the example you want to use. For example, the oled-locator.cpp file. You want to make sure that only a single project is visible in the left-hand folder navigation.

### Using Particle Build (Web IDE)

If you want to use the examples in Particle Build (Web IDE), you need to copy and paste the example source into a new project and then add each of the libraries that it needs.

For example, the oled-locator project has this project.properties.

```
name=oled-locator
dependencies.google-maps-device-locator=0.0.2
dependencies.Adafruit_SSD1306_RK=1.1.2```

You would have to add the libraries **google-maps-device-locator** and **Adafruit_SSD1306_RK** to your project in order to run the sample code.

## Firmware Library API

### Creating an object

You normally create an locator object as a global variable in your program:

```
GoogleMapsDeviceLocator locator;
```

### Operating modes

There are three modes of operation:

If you want to only publish the location once when the device starts up, use withLocateOnce from your setup function.

```
locator.withLocateOnce();
```

To publish every *n* seconds while connected to the cloud, use withLocatePeriodic. The value is in seconds.

```
locator.withLocatePeriodic(120);
```

To manually connect, specify neither option and call publishLocation when you want to publish the location

```
locator.publishLocation();
```

### The loop

With periodic and locate once modes, you must call:

```
locator.loop();
```

from your loop. It doesn't hurt to always call it, even in manual location mode. It gives the library time to process the data.

### Customizing the event name

The default event name is **deviceLocator**. You can change that in setup using:

```
locator.withEventName("myEventName");
```

This also must be updated in the integration, since the eventName is what triggers the webhook. 

![Event Name Configuration](/assets/images/google-maps-22.png)


### Subscription

You can also have the library tell your firmware code what location was found. Use the withSubscribe option with a callback function.

This goes in setup() for example:

```
locator.withSubscribe(locationCallback).withLocatePeriodic(120);
```

The callback function looks like this:

```
void locationCallback(float lat, float lon, float accuracy)
```

One possibility is that you could display this information on a small OLED display, for example.

### Debugging

The library uses the logging feature of system firmware 0.6.0 or later when building for 0.6.0 or later. Adding this line to the top of your .ino file will enable debugging messages to the serial port.

```
SerialLogHandler logHandler;
```


## Example: Google Location Tracker

This example demonstrates how to visualize your Google Maps Device
Locator results using Node.js in a Google App Engine Flexible Environment and the Google Maps Javascript API. This sample also uses the Express web framework, websockets, and the Particle Javascript API.

It can be run from your own computer, as described in the Run Locally section, or it can be deployed to the Google Cloud.

### Sign up for a Google Cloud Platform Account

If you don't already have one, you'll need to sign up for a Google Cloud Platform Account to use this integration.

Visit the <a href="https://cloud.google.com/free-trial/" target="_blank">Google Cloud Platform signup page</a>. Click the "Try it Free" button, and enter the requested information.

### Getting a Google Maps API Key

In order to use the Google Maps API, you need an API key. In many cases, you'll be able to take advantage of the free usage tier. The Maps API key is different than the Geolocation API key you created earlier.

- Go to the [Google Maps Javascript API page](https://developers.google.com/maps/documentation/javascript/).

- If you are not signed into Google already, sign in.

- Use the **Get a Key** button to request a new API key.

![Get a key](/assets/images/google-maps-19.png)

- Select or create a project.

- If you created a project above for the Geolocation API, you may want tp select the same project. I selected **location** and used the **Enable API** button to enable it.

![Enable API](/assets/images/google-maps-20.png)

- And then you'll be presented with your API key.

![API Key](/assets/images/google-maps-21.png)

Copy your key to the clipboard because you'll need it when you create your integration. 

To view, edit or delete your credentials later, you can use the [Google Developer Credentials Console](https://console.developers.google.com/apis/credentials).

#### Get the example source

The firmware source code is in the Github repository:

[https://github.com/rickkas7/google-maps-device-locator-examples](https://github.com/rickkas7/google-maps-device-locator-examples)

You should download the whole thing, either by clone or download zip. This example is in the **appengine** directory.

### Run Locally

#### Install node.js

If you haven't already done so, install [Node.js](https://nodejs.org).

The version on the left, the LTS (long-term support) version is recommended. At the time of writing it was 6.10.2, but install whatever the current LTS version is.

#### Setup

You will need to supply a Google Maps Javascript API key in order for the example to work properly.

- Edit the file `app.js` to set the `map_api_key` variable to your Google Maps API key.

```
const map_api_key = 'YOUR_API_KEY';
```

The Google Maps API key is different than your Google Geolocation API key you used in your integration configuration.

#### Launch

- Install the [Google Cloud SDK](https://cloud.google.com/sdk/). There are installation instructions for Windows, Mac OS X and Linux.

- Setup the gcloud tool. This provides authentication to Google Cloud APIs and services.

```
gcloud init
```

- Acquire local credentials for authenticating with Google Cloud Platform APIs.

```
gcloud beta auth application-default login
```

- Go into the appengine folder and install the dependencies.

```
cd appengine
npm install
```

- Run the sample:

```
npm start
```

- Visit the application at [http://localhost:8080](http://localhost:8080).


### Run in the Cloud

__Note:__ Secure WebSockets are currently not supported by App Engine Flexible Environment. WebSockets will only work if you load your page over HTTP (not HTTPS).

To use Secure WebSockets now, you can launch a VM on Google Compute Engine using a custom image where you have added SSL support for WebSockets.

#### Setup

Before you can run or deploy the sample, you will need to create a new firewall rule to allow traffic on port 50051. This port will be used for websocket connections. You can do this with the [Google Cloud SDK](https://cloud.google.com/sdk) with the following command:

```
    gcloud compute firewall-rules create default-allow-websockets \
      --allow tcp:50051 \
      --target-tags websocket \
      --description "Allow websocket traffic on port 50051"
```
      
#### Deploy

- Use the [Google Developers Console](https://console.developer.google.com) to create a project/app id. (App id and project id are identical.)

- Setup the gcloud tool, if you haven't already.

```
gcloud init
```

- Use gcloud to deploy your app.

```
cd appengine
gcloud app deploy
```

- It will take a few minutes to deploy, but when complete you can view the app at: `http://YOUR_PROJECT_ID.appspot.com`.  

Note that you must use http, not https, because of the websocket limitation mentioned above.

- You can view the server logs using:

```
$ gcloud app logs read
```

One thing to beware of: Deploying a new instance doesn't stop the old one first! Make sure you to clean up the old instances and versions from the [Google Cloud console](https://console.cloud.google.com) App Engine page.

## Example: Location OLED Display

![OLED display](/assets/images/google-maps-15.jpg)

This example displays your current location on a small SSD1306-compatible OLED display to show your latitude, longitude, and uncertainty radius (in meters).

The connections are:

- VCC to 3V3 red
- GND to GND black
- SCL to D1 (SCL) blue
- SDA to D0 (SDA) green

The source code is in the **oled-location** directory.
